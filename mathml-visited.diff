# HG changeset patch
# User Boris Zbarsky <bzbarsky@mit.edu>
# Date 1309371325 14400
# Node ID 23729bbb8153ee2834bc09f845b59225afc5acd6
# Parent ffa5065815c1d0608dd853c5248f1529e164bd9b
Bug 667576.  Handle visited colors correctly in MathML.  r=dbaron

diff --git a/layout/mathml/nsMathMLChar.cpp b/layout/mathml/nsMathMLChar.cpp
--- a/layout/mathml/nsMathMLChar.cpp
+++ b/layout/mathml/nsMathMLChar.cpp
@@ -2039,17 +2039,17 @@ nsMathMLChar::PaintForeground(nsPresCont
 
   if (mDrawNormal) {
     // normal drawing if there is nothing special about this char
     // Set default context to the parent context
     styleContext = parentContext;
   }
 
   // Set color ...
-  nscolor fgColor = styleContext->GetStyleColor()->mColor;
+  nscolor fgColor = styleContext->GetVisitedDependentColor(eCSSProperty_color);
   if (aIsSelected) {
     // get color to use for selection from the look&feel object
     aPresContext->LookAndFeel()->
       GetColor(nsILookAndFeel::eColor_TextSelectForeground, fgColor);
   }
   aRenderingContext.SetColor(fgColor);
 
   nsFont theFont(styleContext->GetStyleFont()->mFont);
diff --git a/layout/mathml/nsMathMLFrame.cpp b/layout/mathml/nsMathMLFrame.cpp
--- a/layout/mathml/nsMathMLFrame.cpp
+++ b/layout/mathml/nsMathMLFrame.cpp
@@ -414,17 +414,17 @@ public:
 private:
   nsRect    mRect;
 };
 
 void nsDisplayMathMLBar::Paint(nsDisplayListBuilder* aBuilder,
                                nsRenderingContext* aCtx)
 {
   // paint the bar with the current text color
-  aCtx->SetColor(mFrame->GetStyleColor()->mColor);
+  aCtx->SetColor(mFrame->GetVisitedDependentColor(eCSSProperty_color));
   aCtx->FillRect(mRect + ToReferenceFrame());
 }
 
 nsresult
 nsMathMLFrame::DisplayBar(nsDisplayListBuilder* aBuilder,
                           nsIFrame* aFrame, const nsRect& aRect,
                           const nsDisplayListSet& aLists) {
   if (!aFrame->GetStyleVisibility()->IsVisible() || aRect.IsEmpty())
diff --git a/layout/mathml/nsMathMLmencloseFrame.cpp b/layout/mathml/nsMathMLmencloseFrame.cpp
--- a/layout/mathml/nsMathMLmencloseFrame.cpp
+++ b/layout/mathml/nsMathMLmencloseFrame.cpp
@@ -754,17 +754,17 @@ private:
 void nsDisplayNotation::Paint(nsDisplayListBuilder* aBuilder,
                               nsRenderingContext* aCtx)
 {
   // get the gfxRect
   nsPresContext* presContext = mFrame->PresContext();
   gfxRect rect = presContext->AppUnitsToGfxUnits(mRect + ToReferenceFrame());
 
   // paint the frame with the current text color
-  aCtx->SetColor(mFrame->GetStyleColor()->mColor);
+  aCtx->SetColor(mFrame->GetVisitedDependentColor(eCSSProperty_color));
 
   // change line width to mThickness
   gfxContext *gfxCtx = aCtx->ThebesContext();
   gfxFloat currentLineWidth = gfxCtx->CurrentLineWidth();
   gfxFloat e = presContext->AppUnitsToGfxUnits(mThickness);
   gfxCtx->SetLineWidth(e);
 
   rect.Deflate(e / 2.0);
diff --git a/layout/mathml/nsMathMLmfracFrame.cpp b/layout/mathml/nsMathMLmfracFrame.cpp
--- a/layout/mathml/nsMathMLmfracFrame.cpp
+++ b/layout/mathml/nsMathMLmfracFrame.cpp
@@ -572,17 +572,17 @@ private:
 void nsDisplayMathMLSlash::Paint(nsDisplayListBuilder* aBuilder,
                                  nsRenderingContext* aCtx)
 {
   // get the gfxRect
   nsPresContext* presContext = mFrame->PresContext();
   gfxRect rect = presContext->AppUnitsToGfxUnits(mRect + ToReferenceFrame());
   
   // paint with the current text color
-  aCtx->SetColor(mFrame->GetStyleColor()->mColor);
+  aCtx->SetColor(mFrame->GetVisitedDependentColor(eCSSProperty_color));
  
   // draw the slash as a parallelogram 
   gfxContext *gfxCtx = aCtx->ThebesContext();
   gfxPoint delta = gfxPoint(presContext->AppUnitsToGfxUnits(mThickness), 0);
   gfxCtx->NewPath();
   gfxCtx->MoveTo(rect.BottomLeft());
   gfxCtx->LineTo(rect.BottomLeft() + delta);
   gfxCtx->LineTo(rect.TopRight());
diff --git a/layout/reftests/mathml/reftest.list b/layout/reftests/mathml/reftest.list
--- a/layout/reftests/mathml/reftest.list
+++ b/layout/reftests/mathml/reftest.list
@@ -77,10 +77,11 @@ fails == mstyle-5.xhtml mstyle-5-ref.xht
 == munderover-align-accent-false.html munderover-align-accent-false-ref.html
 == munderover-align-accent-true.html munderover-align-accent-true-ref.html
 == munder-mover-align-accent-true.html munder-mover-align-accent-true-ref.html
 == munder-mover-align-accent-false.html munder-mover-align-accent-false-ref.html
 == mfrac-linethickness-1.xhtml mfrac-linethickness-1-ref.xhtml
 == mathml-negativespace.html mathml-negativespace-ref.html
 != link-1.xhtml link-ref.xhtml
 != link-2.xhtml link-ref.xhtml
+== visited-styling.html visited-styling-ref.html
 == positive-namedspace.html positive-namedspace-ref.html
 == munderover-empty-scripts.html munderover-empty-scripts-ref.html
diff --git a/layout/reftests/mathml/visited-styling-ref.html b/layout/reftests/mathml/visited-styling-ref.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/mathml/visited-styling-ref.html
@@ -0,0 +1,32 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <style>
+      * { color: green; }
+    </style>
+  </head>
+  <body>
+    <math href="" display="block">
+      <mi>x</mi>
+      <mo>=</mo>
+      <mfrac>
+        <mrow>
+          <msqrt>
+            <mn>5</mn>
+          </msqrt>
+        </mrow>
+        <mrow>
+          <menclose
+             notation="radical circle roundedbox updiagonalstrike downdiagonalstrike">
+            <mn>2</mn>
+          </menclose>
+        </mrow>
+      </mfrac>
+      <mo>+</mo>
+      <mfrac bevelled="true">
+        <mn>2</mn>
+        <mn>3</mn>
+      </mfrac>
+    </math>
+  </body>
+</html>
diff --git a/layout/reftests/mathml/visited-styling.html b/layout/reftests/mathml/visited-styling.html
new file mode 100644
--- /dev/null
+++ b/layout/reftests/mathml/visited-styling.html
@@ -0,0 +1,33 @@
+<!DOCTYPE HTML>
+<html>
+  <head>
+    <style>
+      :link { color: red; }
+      :visited { color: green; }
+    </style>
+  </head>
+  <body>
+    <math href="" display="block">
+      <mi>x</mi>
+      <mo>=</mo>
+      <mfrac>
+        <mrow>
+          <msqrt>
+            <mn>5</mn>
+          </msqrt>
+        </mrow>
+        <mrow>
+          <menclose
+             notation="radical circle roundedbox updiagonalstrike downdiagonalstrike">
+            <mn>2</mn>
+          </menclose>
+        </mrow>
+      </mfrac>
+      <mo>+</mo>
+      <mfrac bevelled="true">
+        <mn>2</mn>
+        <mn>3</mn>
+      </mfrac>
+    </math>
+  </body>
+</html>
