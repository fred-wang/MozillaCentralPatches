# HG changeset patch
# Parent 2a1f43bf43941211b2d65acf0f47f1ede5d8a42e
# User Frédéric Wang <fred.wang@free.fr>
Bug 295193 - Allow downloading math fonts with Firefox - part 1.

diff --git a/browser/base/content/browser.js b/browser/base/content/browser.js
--- a/browser/base/content/browser.js
+++ b/browser/base/content/browser.js
@@ -1415,28 +1415,64 @@ function HandleAppCommandEvent(evt) {
   case "Home":
     BrowserHome();
     break;
   default:
     break;
   }
 }
 
+function HandleMissingMathMLFontsEvent(aEvent) {
+  var nb = gBrowser.getNotificationBox();
+  var bundle = gNavigatorBundle;
+  var message = bundle.getString("mathFontsWarning.message");
+  var buttons = [{
+    label: bundle.getString("mathFontsWarning.install"),
+    accessKey: bundle.getString("mathFontsWarning.install.accessKey"),
+    callback: function() {
+      openNewTabWith("https://addons.mozilla.org/en-US/firefox/addon/mathml-fonts/",
+                     null, null, null, true);
+    }
+  }, {
+    label: bundle.getString("mathFontsWarning.info"),
+    accessKey: bundle.getString("mathFontsWarning.info.accessKey"),
+    callback: function() {
+      openNewTabWith("https://developer.mozilla.org/en/Mozilla_MathML_Project/Fonts",
+                     null, null, null, true);
+    }
+  }, {  
+    label: bundle.getString("mathFontsWarning.dontShowAgain"),
+    accessKey: bundle.getString("mathFontsWarning.dontShowAgain.accessKey"),
+    callback: function() {
+      gPrefService.setBoolPref("font.mathfont-warning", false);
+    }
+  }];
+  var id = 'mathml-missing-fonts';
+  var previousNotification = nb.getNotificationWithValue(id);
+  if (previousNotification)
+      notificationBox.removeNotification(previousNotification);
+  nb.appendNotification(message, id,
+                        'chrome://browser/skin/Info.png',
+                        nb.PRIORITY_WARNING_MEDIUM, buttons);
+}
+
 function prepareForStartup() {
   gBrowser.addEventListener("DOMUpdatePageReport", gPopupBlockerObserver, false);
 
   gBrowser.addEventListener("PluginNotFound",     gPluginHandler, true);
   gBrowser.addEventListener("PluginCrashed",      gPluginHandler, true);
   gBrowser.addEventListener("PluginBlocklisted",  gPluginHandler, true);
   gBrowser.addEventListener("PluginOutdated",     gPluginHandler, true);
   gBrowser.addEventListener("PluginDisabled",     gPluginHandler, true);
   gBrowser.addEventListener("NewPluginInstalled", gPluginHandler.newPluginInstalled, true);
 #ifdef XP_MACOSX
   gBrowser.addEventListener("npapi-carbon-event-model-failure", gPluginHandler, true);
 #endif
+  gBrowser.addEventListener("DOMMissingMathMLFonts",
+                            HandleMissingMathMLFontsEvent, true);
 
   Services.obs.addObserver(gPluginHandler.pluginCrashed, "plugin-crashed", false);
 
   window.addEventListener("AppCommand", HandleAppCommandEvent, true);
 
   var webNavigation;
   try {
     webNavigation = getWebNavigation();
diff --git a/browser/locales/en-US/chrome/browser/browser.properties b/browser/locales/en-US/chrome/browser/browser.properties
--- a/browser/locales/en-US/chrome/browser/browser.properties
+++ b/browser/locales/en-US/chrome/browser/browser.properties
@@ -355,8 +355,17 @@ keywordPrompt.yesButton.accessKey = Y
 # LOCALIZATION NOTE (keywordPrompt.noButton): %1$S is a host name (e.g. "somewebsearch.com") from the current value of keyword.URL
 keywordPrompt.noButton = No, continue using '%1$S'
 keywordPrompt.noButton.accessKey  = N
 
 # Telemetry opt-out prompt for Aurora and Nightly
 # LOCALIZATION NOTE (telemetryOptOutPrompt): %1$S and %3$S will be replaced by
 # brandFullName, and %2$S by the value of the toolkit.telemetry.server_owner preference.
 telemetryOptOutPrompt = %1$S sends information about performance, hardware, usage and customizations back to %2$S to help improve %3$S.
+
+# Missing MathML fonts warning
+mathFontsWarning.message = Mathematical fonts are recommended to render this page correctly
+mathFontsWarning.install = Install MathML-fonts add-on
+mathFontsWarning.install.accessKey = I
+mathFontsWarning.info = About math fonts
+mathFontsWarning.info.accessKey = A
+mathFontsWarning.dontShowAgain = Do not show again
+mathFontsWarning.dontShowAgain.accessKey = D
