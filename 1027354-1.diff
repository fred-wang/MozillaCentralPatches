
# HG changeset patch
# User James Kitchener <jkitch.bug@gmail.com>
# Date 1403270365 -34200
# Node ID b1dbd771595d566ec5af5944d743a9bcf340e2b1
# Parent  bdac18bd6c7441154559413600d80a340d026bda
Bug 1027354 - Fix legacy fontstyle/fontweight on single char <mi>

diff --git a/content/base/src/nsGkAtomList.h b/content/base/src/nsGkAtomList.h
--- a/content/base/src/nsGkAtomList.h
+++ b/content/base/src/nsGkAtomList.h
@@ -1505,16 +1505,19 @@ GK_ATOM(onrepeat, "onrepeat")
 GK_ATOM(onrepeatEvent, "onrepeatEvent")
 GK_ATOM(repeatCount, "repeatCount")
 GK_ATOM(repeatDur, "repeatDur")
 GK_ATOM(repeatEvent, "repeatEvent")
 GK_ATOM(restart, "restart")
 GK_ATOM(to, "to")
 GK_ATOM(XML, "XML")
 
+// internal MathML attributes:
+GK_ATOM(_moz_math_fontstyle_, "_moz-math-font-style")
+
 GK_ATOM(abs_, "abs")
 GK_ATOM(accent_, "accent")
 GK_ATOM(accentunder_, "accentunder")
 GK_ATOM(actiontype_, "actiontype")
 GK_ATOM(alignmentscope_, "alignmentscope")
 GK_ATOM(altimg_, "altimg")
 GK_ATOM(altimg_height_, "altimg-height")
 GK_ATOM(altimg_valign_, "altimg-valign")
diff --git a/layout/generic/MathMLTextRunFactory.cpp b/layout/generic/MathMLTextRunFactory.cpp
--- a/layout/generic/MathMLTextRunFactory.cpp
+++ b/layout/generic/MathMLTextRunFactory.cpp
@@ -590,17 +590,21 @@ MathMLTextRunFactory::RebuildTextRun(nsT
   uint8_t mathVar;
   bool doMathvariantStyling = true;
 
   for (uint32_t i = 0; i < length; ++i) {
     int extraChars = 0;
     nsStyleContext* styleContext = styles[i];
     mathVar = styleContext->StyleFont()->mMathVariant;
 
-    if (singleCharMI && mathVar == NS_MATHML_MATHVARIANT_NONE) {
+    // non-default values of fontstyle and fontweight override the
+    // mathvariant character substitution routine.
+    if (singleCharMI && mathVar == NS_MATHML_MATHVARIANT_NONE &&
+        NS_FONT_STYLE_NORMAL != fontStyle.style &&
+        NS_FONT_WEIGHT_BOLD != fontStyle.weight) {
       mathVar = NS_MATHML_MATHVARIANT_ITALIC;
     }
 
     uint32_t ch = str[i];
     if (NS_IS_HIGH_SURROGATE(ch) && i < length - 1 &&
         NS_IS_LOW_SURROGATE(str[i + 1])) {
       ch = SURROGATE_TO_UCS4(ch, str[i + 1]);
     }

