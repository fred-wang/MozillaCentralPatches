# HG changeset patch
# Parent 24f0330968ced0a45d0ea3c2478e5d78117a46a5
# User Frédéric Wang <fred.wang@free.fr>
Bug 569124 - Make the math element support the attributes of mstyle. r=karlt

diff --git a/content/mathml/content/src/nsMathMLElement.cpp b/content/mathml/content/src/nsMathMLElement.cpp
--- a/content/mathml/content/src/nsMathMLElement.cpp
+++ b/content/mathml/content/src/nsMathMLElement.cpp
@@ -174,24 +174,24 @@ nsMathMLElement::IsAttributeMapped(const
   
   // We don't support mglyph (yet).
   nsIAtom* tag = Tag();
   if (tag == nsGkAtoms::ms_ || tag == nsGkAtoms::mi_ ||
       tag == nsGkAtoms::mn_ || tag == nsGkAtoms::mo_ ||
       tag == nsGkAtoms::mtext_ || tag == nsGkAtoms::mspace_)
     return FindAttributeDependence(aAttribute, tokenMap,
                                    NS_ARRAY_LENGTH(tokenMap));
-  if (tag == nsGkAtoms::mstyle_)
+  if (tag == nsGkAtoms::mstyle_ ||
+      tag == nsGkAtoms::math)
     return FindAttributeDependence(aAttribute, mstyleMap,
                                    NS_ARRAY_LENGTH(mstyleMap));
 
   if (tag == nsGkAtoms::maction_ ||
       tag == nsGkAtoms::maligngroup_ ||
       tag == nsGkAtoms::malignmark_ ||
-      tag == nsGkAtoms::math ||
       tag == nsGkAtoms::menclose_ ||
       tag == nsGkAtoms::merror_ ||
       tag == nsGkAtoms::mfenced_ ||
       tag == nsGkAtoms::mfrac_ ||
       tag == nsGkAtoms::mover_ ||
       tag == nsGkAtoms::mpadded_ ||
       tag == nsGkAtoms::mphantom_ ||
       tag == nsGkAtoms::mprescripts_ ||
diff --git a/layout/mathml/nsMathMLFrame.cpp b/layout/mathml/nsMathMLFrame.cpp
--- a/layout/mathml/nsMathMLFrame.cpp
+++ b/layout/mathml/nsMathMLFrame.cpp
@@ -226,16 +226,17 @@ nsMathMLFrame::GetPresentationDataFrom(n
     if (!content)
       break;
 
     if (content->Tag() == nsGkAtoms::math) {
       const nsStyleDisplay* display = frame->GetStyleDisplay();
       if (display->mDisplay == NS_STYLE_DISPLAY_BLOCK) {
         aPresentationData.flags |= NS_MATHML_DISPLAYSTYLE;
       }
+      aPresentationData.mstyle = frame;
       break;
     }
     frame = frame->GetParent();
   }
   NS_WARN_IF_FALSE(frame && frame->GetContent(),
                    "bad MathML markup - could not find the top <math> element");
 }
 
diff --git a/layout/reftests/mathml/math-as-mstyle-1-ref.xhtml b/layout/reftests/mathml/math-as-mstyle-1-ref.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/mathml/math-as-mstyle-1-ref.xhtml
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+  <title>math as mstyle</title>
+</head>
+<body>
+
+<p>
+  <math xmlns="http://www.w3.org/1998/Math/MathML">
+    <mfrac numalign="right">
+      <mn>123</mn>
+      <mn>456789</mn>
+    </mfrac>
+  </math>
+</p>
+
+<p>
+  <math xmlns="http://www.w3.org/1998/Math/MathML">
+    <mstyle scriptlevel="-2">
+      <mfrac>
+        <mi>a</mi>
+        <mi>b</mi>
+      </mfrac>
+    </mstyle>
+  </math>
+</p>
+
+</body>
+</html>
diff --git a/layout/reftests/mathml/math-as-mstyle-1.xhtml b/layout/reftests/mathml/math-as-mstyle-1.xhtml
new file mode 100644
--- /dev/null
+++ b/layout/reftests/mathml/math-as-mstyle-1.xhtml
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<html xmlns="http://www.w3.org/1999/xhtml">
+<head>
+  <title>math as mstyle</title>
+</head>
+<body>
+
+<p>
+  <math xmlns="http://www.w3.org/1998/Math/MathML" numalign="right">
+    <mfrac>
+      <mn>123</mn>
+      <mn>456789</mn>
+    </mfrac>
+  </math>
+</p>
+
+<p>
+  <math xmlns="http://www.w3.org/1998/Math/MathML" scriptlevel="-2">
+    <mfrac>
+      <mi>a</mi>
+      <mi>b</mi>
+    </mfrac>
+  </math>
+</p>
+
+</body>
+</html>
diff --git a/layout/reftests/mathml/reftest.list b/layout/reftests/mathml/reftest.list
--- a/layout/reftests/mathml/reftest.list
+++ b/layout/reftests/mathml/reftest.list
@@ -32,8 +32,9 @@
 == mathbackground-4.xml mathbackground-4-ref.xml
 == scale-stretchy-1.xhtml scale-stretchy-1-ref.xhtml
 != scale-stretchy-2.xhtml scale-stretchy-2-ref.xhtml
 == scale-stretchy-3.xhtml scale-stretchy-3-ref.xhtml
 != scale-stretchy-4.xhtml scale-stretchy-4-ref.xhtml
 != scale-stretchy-5.xhtml scale-stretchy-5-ref.xhtml
 != link-1.xhtml link-ref.xhtml
 != link-2.xhtml link-ref.xhtml
+== math-as-mstyle-1.xhtml math-as-mstyle-1-ref.xhtml
