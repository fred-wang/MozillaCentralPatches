# HG changeset patch
# Parent fac0311da921bf14a32042a0df3c7439ad59c541
# User Frédéric Wang <fred.wang@free.fr>
Bug 295193 - Allow downloading math fonts in Firefox - part 1.

diff --git a/layout/base/nsPresContext.cpp b/layout/base/nsPresContext.cpp
--- a/layout/base/nsPresContext.cpp
+++ b/layout/base/nsPresContext.cpp
@@ -2391,16 +2391,22 @@ nsPresContext::IsRootContentDocument()
   if (!view) {
     return true;
   }
 
   nsIFrame* f = view->GetFrame();
   return (f && f->PresContext()->IsChrome());
 }
 
+bool
+nsPresContext::IsLoadingFonts()
+{
+  return mUserFontSet && mUserFontSet->IsLoadingFonts();
+}
+
 nsRootPresContext::nsRootPresContext(nsIDocument* aDocument,
                                      nsPresContextType aType)
   : nsPresContext(aDocument, aType),
     mUpdatePluginGeometryForFrame(nsnull),
     mDOMGeneration(0),
     mNeedsToUpdatePluginGeometry(false)
 {
   mRegisteredPlugins.Init();
diff --git a/layout/base/nsPresContext.h b/layout/base/nsPresContext.h
--- a/layout/base/nsPresContext.h
+++ b/layout/base/nsPresContext.h
@@ -970,16 +970,18 @@ public:
 
   virtual size_t SizeOfExcludingThis(nsMallocSizeOfFun aMallocSizeOf) const;
   virtual size_t SizeOfIncludingThis(nsMallocSizeOfFun aMallocSizeOf) const {
     return aMallocSizeOf(this) + SizeOfExcludingThis(aMallocSizeOf);
   }
 
   bool IsRootContentDocument();
 
+  bool IsLoadingFonts();
+
 protected:
   friend class nsRunnableMethod<nsPresContext>;
   NS_HIDDEN_(void) ThemeChangedInternal();
   NS_HIDDEN_(void) SysColorChangedInternal();
 
   NS_HIDDEN_(void) SetImgAnimations(nsIContent *aParent, PRUint16 aMode);
   NS_HIDDEN_(void) SetSMILAnimations(nsIDocument *aDoc, PRUint16 aNewMode,
                                      PRUint16 aOldMode);
diff --git a/layout/mathml/nsMathMLChar.cpp b/layout/mathml/nsMathMLChar.cpp
--- a/layout/mathml/nsMathMLChar.cpp
+++ b/layout/mathml/nsMathMLChar.cpp
@@ -62,27 +62,73 @@
 #include "nsCSSRendering.h"
 #include "prprf.h"         // For PR_snprintf()
 
 #include "nsDisplayList.h"
 
 #include "nsMathMLOperators.h"
 #include "nsMathMLChar.h"
 
+#include "nsThreadUtils.h"
+#include "nsEventDispatcher.h"
+#include "nsIPrivateDOMEvent.h"
+
 using namespace mozilla;
 
 //#define SHOW_BORDERS 1
 //#define NOISY_SEARCH 1
 
 // -----------------------------------------------------------------------------------
 static const PRUnichar   kSpaceCh   = PRUnichar(' ');
 static const nsGlyphCode kNullGlyph = {{0, 0}, 0};
 typedef enum {eExtension_base, eExtension_variants, eExtension_parts}
   nsMathfontPrefExtension;
 
+// -----------------------------------------------------------------------------
+static bool gMathFontWarning = false;
+
+static int
+PrefsChanged(const char *aPrefName, void *aData)
+{
+  gMathFontWarning =
+    Preferences::GetBool("font.mathfont-warning", gMathFontWarning);
+
+  return 0; /* PREF_OK */
+}
+
+class nsFontNotificationEvent : public nsRunnable
+{
+public:
+  nsFontNotificationEvent(nsPresContext* aPresContext)
+    : mPresContext(aPresContext)
+  {
+  }
+
+  NS_IMETHOD Run()
+  {
+    nsCOMPtr<nsIDOMEvent> event;
+    if (NS_SUCCEEDED(nsEventDispatcher::CreateEvent(mPresContext, nsnull,
+                                                    NS_LITERAL_STRING("Events"),
+                                                    getter_AddRefs(event)))) {
+      event->InitEvent(NS_LITERAL_STRING("DOMMissingMathMLFonts"), true, true);
+
+      nsCOMPtr<nsIPrivateDOMEvent> privateEvent = do_QueryInterface(event);
+      privateEvent->SetTrusted(true);
+
+      nsEventDispatcher::DispatchDOMEvent(mPresContext->Document(),
+                                          nsnull, event,
+                                          mPresContext, nsnull);
+    }
+    return NS_OK;
+  }
+  
+private:
+  nsPresContext* mPresContext;
+};
+
 // -----------------------------------------------------------------------------------
 // nsGlyphTable is a class that provides an interface for accessing glyphs
 // of stretchy chars. It acts like a table that stores the variants of bigger
 // sizes (if any) and the partial glyphs needed to build extensible symbols.
 // An instance of nsGlyphTable is associated to one primary font. Extra glyphs
 // can be taken in other additional fonts when stretching certain characters.
 // These supplementary fonts are referred to as "external" fonts to the table.
 //
@@ -493,16 +539,20 @@ public:
   nsGlyphTable*
   GetGlyphTableFor(nsPresContext* aPresContext,
                    nsMathMLChar*  aChar);
 
   // Find the glyph table in the list corresponding to the given font family.
   nsGlyphTable*
   GetGlyphTableFor(const nsAString& aFamily);
 
+  // Determine whether the given char can be built by parts
+  bool HasPartsFor(nsPresContext* aPresContext,
+                   nsMathMLChar*  aChar);
+
 private:
   nsGlyphTable* TableAt(PRInt32 aIndex) {
     return &mTableList.ElementAt(aIndex);
   }
   PRInt32 Count() {
     return mTableList.Length();
   }
 
@@ -599,16 +649,32 @@ nsGlyphTableList::GetGlyphTableFor(const
     if (fontName.Equals(aFamily, nsCaseInsensitiveStringComparator())) {
       return glyphTable;
     }
   }
   // Fall back to default Unicode table
   return &mUnicodeTable;
 }
 
+bool
+nsGlyphTableList::HasPartsFor(nsPresContext* aPresContext, 
+                              nsMathMLChar*   aChar)
+{
+  if (mUnicodeTable.HasPartsOf(aPresContext, aChar))
+    return true;
+
+  PRInt32 i;
+  for (i = 0; i < Count(); i++) {
+    nsGlyphTable* glyphTable = TableAt(i);
+    if (glyphTable->HasPartsOf(aPresContext, aChar)) {
+      return true;
+    }
+  }
+  return false;
+}
 // -----------------------------------------------------------------------------------
 
 // Lookup the preferences:
 // "font.mathfont-family.\uNNNN.base"     -- fonts for the base size
 // "font.mathfont-family.\uNNNN.variants" -- fonts for larger glyphs
 // "font.mathfont-family.\uNNNN.parts"    -- fonts for partial glyphs
 // Given the char code and mode of stretch, retrieve the preferred extension
 // font families.
@@ -677,16 +743,20 @@ MathFontEnumCallback(const nsString& aFa
 }
 
 static nsresult
 InitGlobals(nsPresContext* aPresContext)
 {
   NS_ASSERTION(!gInitialized, "Error -- already initialized");
   gInitialized = true;
 
+  // Set up a listener for mathfont-warning and check the initial value
+  Preferences::RegisterCallback(PrefsChanged, "font.mathfont-warning");
+  PrefsChanged(nsnull, nsnull);
+
   // Allocate the placeholders for the preferred parts and variants
   nsresult rv = NS_ERROR_OUT_OF_MEMORY;
   gGlyphTableList = new nsGlyphTableList();
   if (gGlyphTableList) {
     rv = gGlyphTableList->Initialize();
   }
   if (NS_FAILED(rv)) {
     delete gGlyphTableList;
@@ -717,18 +787,16 @@ InitGlobals(nsPresContext* aPresContext)
   // We just want to iterate over the font-family list using the
   // callback mechanism that nsFont has...
   nsFont font("", 0, 0, 0, 0, 0, 0);
   NS_NAMED_LITERAL_CSTRING(defaultKey, "font.mathfont-glyph-tables");
   rv = mathfontProp->GetStringProperty(defaultKey, font.name);
   if (NS_FAILED(rv)) return rv;
 
   // Parse the font list and append an entry for each family to gGlyphTableList
-  nsAutoString missingFamilyList;
-
   font.EnumerateFamilies(MathFontEnumCallback, nsnull);
   return rv;
 }
 
 // -----------------------------------------------------------------------------------
 // And now the implementation of nsMathMLChar
 
 nsStyleContext*
@@ -1679,16 +1747,33 @@ nsMathMLChar::StretchInternal(nsPresCont
       if (!maxWidth) {
         mScaleY *= scale;
       }
       aDesiredStretchSize.ascent *= scale;
       aDesiredStretchSize.descent *= scale;
     }
   }
 
+  if (!maxWidth && gMathFontWarning && !aPresContext->IsLoadingFonts()) {
+    // Send a warning if it seems that the mathematical fonts available are not
+    // enough to stretch the operators. Heuristic rules to determine whether
+    // fonts are missing:
+    // - No glyph variants are available for a largeop in display mode, whereas
+    //   a glyph table was initially found to exist for this character.
+    // - A large scale transform is applied to stretch a character that
+    //   could actually be built by parts with the appropriate fonts installed.
+    if ((!glyphFound && largeop && mGlyphTable) ||
+        ((mScaleX > 2.0 || mScaleY > 2.0) &&
+         gGlyphTableList->HasPartsFor(aPresContext, this))) {
+      // Dispatch the notification
+      nsCOMPtr<nsIRunnable> event = new nsFontNotificationEvent(aPresContext);
+      NS_DispatchToCurrentThread(event);
+    }
+  }
+
   return NS_OK;
 }
 
 nsresult
 nsMathMLChar::Stretch(nsPresContext*           aPresContext,
                       nsRenderingContext&     aRenderingContext,
                       nsStretchDirection       aStretchDirection,
                       const nsBoundingMetrics& aContainerSize,
diff --git a/layout/style/nsFontFaceLoader.h b/layout/style/nsFontFaceLoader.h
--- a/layout/style/nsFontFaceLoader.h
+++ b/layout/style/nsFontFaceLoader.h
@@ -83,16 +83,18 @@ public:
 
   nsPresContext *GetPresContext() { return mPresContext; }
 
   virtual void ReplaceFontEntry(gfxProxyFontEntry *aProxy,
                                 gfxFontEntry *aFontEntry);
 
   nsCSSFontFaceRule *FindRuleForEntry(gfxFontEntry *aFontEntry);
 
+  bool IsLoadingFonts() { return mLoaders.Count() > 0; }
+
 protected:
   // The font-set keeps track of the collection of rules, and their
   // corresponding font entries (whether proxies or real entries),
   // so that we can update the set without having to throw away
   // all the existing fonts.
   struct FontFaceRuleRecord {
     nsRefPtr<gfxFontEntry>       mFontEntry;
     nsFontFaceRuleContainer      mContainer;
diff --git a/modules/libpref/src/init/all.js b/modules/libpref/src/init/all.js
--- a/modules/libpref/src/init/all.js
+++ b/modules/libpref/src/init/all.js
@@ -3537,8 +3537,11 @@ pref("memory.low_commit_space_threshold_
 // than this many mb of physical memory available on the whole machine.
 pref("memory.low_physical_memory_threshold_mb", 0);
 
 // On Windows 32- or 64-bit, don't fire a low-memory notification because of
 // low available physical memory or low commit space more than once every
 // low_memory_notification_interval_ms.
 pref("memory.low_memory_notification_interval_ms", 10000);
 #endif
+
+// warning for missing MathML fonts
+pref("font.mathfont-warning", true);
