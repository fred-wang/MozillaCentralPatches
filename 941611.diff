# HG changeset patch
# Parent 9bcc52594322d06609796f8b8af8778f6e34360a
# User James Kitchener <jkitch.bug@gmail.com>
Bug 941611 - More consistent rounding of text metrics

diff --git a/layout/generic/nsTextFrame.cpp b/layout/generic/nsTextFrame.cpp
--- a/layout/generic/nsTextFrame.cpp
+++ b/layout/generic/nsTextFrame.cpp
@@ -7377,18 +7377,19 @@ nsTextFrame::GetPrefWidthTightBounds(nsR
                             nsTextFrame::eInflated);
   provider.InitializeForMeasure();
 
   gfxTextRun::Metrics metrics =
         mTextRun->MeasureText(provider.GetStart().GetSkippedOffset(),
                               ComputeTransformedLength(provider),
                               gfxFont::TIGHT_HINTED_OUTLINE_EXTENTS,
                               aContext->ThebesContext(), &provider);
-  *aX = metrics.mBoundingBox.x;
-  *aXMost = metrics.mBoundingBox.XMost();
+  // Round it like nsTextFrame::ComputeTightBounds() to ensure consistency.
+  *aX = NSToCoordFloor(metrics.mBoundingBox.x);
+  *aXMost = NSToCoordCeil(metrics.mBoundingBox.XMost());
 
   return NS_OK;
 }
 
 static bool
 HasSoftHyphenBefore(const nsTextFragment* aFrag, gfxTextRun* aTextRun,
                     int32_t aStartOffset, const gfxSkipCharsIterator& aIter)
 {
diff --git a/layout/reftests/mathml/reftest.list b/layout/reftests/mathml/reftest.list
--- a/layout/reftests/mathml/reftest.list
+++ b/layout/reftests/mathml/reftest.list
@@ -39,18 +39,18 @@ fails-if(winWidget) == mfenced-10.html m
 == mi-mathvariant-1.xhtml mi-mathvariant-1-ref.xhtml
 == mi-mathvariant-2.xhtml mi-mathvariant-2-ref.xhtml
 != non-spacing-accent-1.xhtml non-spacing-accent-1-ref.xhtml
 == overbar-width-1.xhtml overbar-width-1-ref.xhtml
 skip-if(B2G) == quotes-1.xhtml quotes-1-ref.xhtml
 != stretchy-underbar-1.xhtml stretchy-underbar-1-ref.xhtml 
 == table-width-1.xhtml table-width-1-ref.xhtml
 == table-width-2.html table-width-2-ref.html
-fails-if(OSX||/^Windows\x20NT\x206\.[^0]/.test(http.oscpu)||Android) == table-width-3.html table-width-3-ref.html
-fails-if((OSX&&(OSX<10.8))||/^Windows\x20NT\x206\.[^0]/.test(http.oscpu)||Android) == table-width-4.html table-width-4-ref.html
+== table-width-3.html table-width-3-ref.html
+== table-width-4.html table-width-4-ref.html
 == underbar-width-1.xhtml underbar-width-1-ref.xhtml
 == mathml-type-supported.xhtml mathml-type-supported-ref.xml
 == mtable-align-negative-rownumber.html mtable-align-negative-rownumber-ref.html
 != embellished-op-1-1.html embellished-op-1-1-ref.html
 != embellished-op-1-2.html embellished-op-1-2-ref.html
 != embellished-op-1-3.html embellished-op-1-3-ref.html
 != embellished-op-1-4.html embellished-op-1-4-ref.html
 != embellished-op-1-5.html embellished-op-1-5-ref.html
diff --git a/layout/reftests/mathml/table-width-1-ref.xhtml b/layout/reftests/mathml/table-width-1-ref.xhtml
--- a/layout/reftests/mathml/table-width-1-ref.xhtml
+++ b/layout/reftests/mathml/table-width-1-ref.xhtml
@@ -1,14 +1,17 @@
 <html xmlns="http://www.w3.org/1999/xhtml">
   <head>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-           padding: 0;
+           padding-top: 0;
+           padding-bottom: 0;
+           padding-right: 1px;
+           padding-left: 1px;
            background-color: black;
            color: red; }
     </style>
   </head>
 <body>
   <table>
     <td>
       <math xmlns="http://www.w3.org/1998/Math/MathML">
diff --git a/layout/reftests/mathml/table-width-1.xhtml b/layout/reftests/mathml/table-width-1.xhtml
--- a/layout/reftests/mathml/table-width-1.xhtml
+++ b/layout/reftests/mathml/table-width-1.xhtml
@@ -1,15 +1,18 @@
 <html xmlns="http://www.w3.org/1999/xhtml">
   <head>
     <title>Check that the content box is large enough</title>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-           padding: 0;
+           padding-top: 0;
+           padding-bottom: 0;
+           padding-right: 1px;
+           padding-left: 1px;
            background-color: black;
            color: black; }
     </style>
   </head>
 <body>
   <table>
     <td>
       <math xmlns="http://www.w3.org/1998/Math/MathML">
diff --git a/layout/reftests/mathml/table-width-3-ref.html b/layout/reftests/mathml/table-width-3-ref.html
--- a/layout/reftests/mathml/table-width-3-ref.html
+++ b/layout/reftests/mathml/table-width-3-ref.html
@@ -1,17 +1,20 @@
 <!doctype>
 <html>
   <head>
     <title>table-width-3</title>
     <meta charset="utf-8"/>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-      padding: 0;
+      padding-top: 0;
+      padding-bottom: 0;
+      padding-right: 1px;
+      padding-left: 1px;
       background-color: black;
       color: red; }
       mi, mtext { font-size: 3em; }
       span { font-style: italic; display: inline-block; }
     </style>
   </head>
   <body>
 
diff --git a/layout/reftests/mathml/table-width-3.html b/layout/reftests/mathml/table-width-3.html
--- a/layout/reftests/mathml/table-width-3.html
+++ b/layout/reftests/mathml/table-width-3.html
@@ -1,17 +1,20 @@
 <!doctype>
 <html>
   <head>
     <title>table-width-3</title>
     <meta charset="utf-8"/>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-      padding: 0;
+      padding-top: 0;
+      padding-bottom: 0;
+      padding-right: 1px;
+      padding-left: 1px;
       background-color: black;
       color: black; }
       mi, mtext { font-size: 3em; }
       span { font-style: italic; display: inline-block; }
     </style>
   </head>
   <body>
 
diff --git a/layout/reftests/mathml/table-width-4-ref.html b/layout/reftests/mathml/table-width-4-ref.html
--- a/layout/reftests/mathml/table-width-4-ref.html
+++ b/layout/reftests/mathml/table-width-4-ref.html
@@ -1,17 +1,20 @@
 <!doctype>
 <html>
   <head>
     <title>table-width-4</title>
     <meta charset="utf-8"/>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-      padding: 0;
+      padding-top: 0;
+      padding-bottom: 0;
+      padding-right: 1px;
+      padding-left: 1px;
       background-color: black;
       color: black; }
     </style>
   </head>
   <body>
 
     <table>
       <tr>
diff --git a/layout/reftests/mathml/table-width-4.html b/layout/reftests/mathml/table-width-4.html
--- a/layout/reftests/mathml/table-width-4.html
+++ b/layout/reftests/mathml/table-width-4.html
@@ -1,17 +1,20 @@
 <!doctype>
 <html>
   <head>
     <title>table-width-4</title>
     <meta charset="utf-8"/>
     <style type="text/css">
       html { background-color: grey; }
       td { border: 1px solid white;
-      padding: 0;
+      padding-top: 0;
+      padding-bottom: 0;
+      padding-right: 1px;
+      padding-left: 1px;
       background-color: black;
       color: black; }
     </style>
   </head>
   <body>
 
     <table>
       <tr>
